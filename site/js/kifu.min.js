(function(d){function c(j){this.size=parseInt(j)||19;this.stones=null;this.annotations=null;this._events={};this.clearBoard();this.clearAnnotations()}c.prototype.addEventListener=function(k,l){var j=this._events[k]=this._events[k]||[];j.push(l)};c.prototype.dispatchEvent=function(m,j){if(this._events.hasOwnProperty(m)){var l=this._events[m],k;for(k=0;k<l.length;k++){l[k].apply(this,j)}}};c.prototype.clearAnnotations=function(){this.annotations=new Array(this.size);for(var j=0;j<this.stones.length;j++){this.annotations[j]=new Array(this.size)}};c.prototype.clearBoard=function(){this.stones=new Array(this.size);for(var j=0;j<this.stones.length;j++){this.stones[j]=new Array(this.size)}};c.prototype.addStone=function(j,n,l,k){if(j<this.stones.length&&n<this.stones.length&&!this.stones[j][n]){var m=new i(j,n,this,l);this.stones[j][n]=m;m.mergeGroup();m.killNeighbors()}if(!k){this.dispatchEvent("change")}};c.prototype.serialize=function(){var k={w:[],b:[],size:this.size},n,m,l;for(m=0;m<this.stones.length;m++){for(l=0;l<this.stones.length;l++){n=this.stones[m][l];if(n){k[n.color].push({x:m,y:l})}}}return JSON.stringify(k)};c.prototype.deserialize=function(j){if(typeof j==="string"){j=JSON.parse(j)}var k=this;k.size=j.hasOwnProperty("size")?j.size:19;k.clearBoard();if(j.hasOwnProperty("w")){j.w.forEach(function(l){k.addStone(l.x,l.y,"w",true)})}if(j.hasOwnProperty("b")){j.b.forEach(function(l){k.addStone(l.x,l.y,"b",true)})}this.dispatchEvent("change")};function i(j,m,l,k){this.x=j;this.y=m;this.board=l;this.color=k;this.group=null}i.prototype.neighbors=function(n,m){m=m||"map";var l=[{x:this.x-1,y:this.y},{x:this.x+1,y:this.y},{x:this.x,y:this.y-1},{x:this.x,y:this.y+1}],k=this.board,j=this;return l.filter(function(o){return o.x>=0&&o.y>=0&&o.x<k.stones.length&&o.y<k.stones.length})[m](function(o){return n.call(j,k.stones[o.x][o.y])})};i.prototype.rediscoverGroup=function(k){if(!k){k=new g()}if(this.group){this.group.stones=this.group.stones.filter(function(l){return l!=this})}this.group=k;this.group.stones.push(this);var j=function(l){if(l&&this.color==l.color&&this.group!=l.group){l.rediscoverGroup(k)}};this.neighbors(j)};i.prototype.mergeGroup=function(){var j=function(k){if(k&&k.color==this.color){var l=k.group;if(this.group&&l){l.setNewGroup(this.group)}else{if(l){this.group=l;l.stones.push(this)}else{k.group=this.group=new g([this,k])}}}};this.neighbors(j)};i.prototype.killNeighbors=function(){var j=function(l){if(l&&l.color!=this.color){var k=l.group||l;if(!k.hasLiberty()){k.die()}}};this.neighbors(j)};i.prototype.hasLiberty=function(){var j=function(k){return !k};return this.neighbors(j,"some")};i.prototype.die=function(){this.removeFromBoard()};i.prototype.removeFromBoard=function(){this.board.stones[this.x][this.y]=null;if(this.group){this.group=null;this.neighbors(function(j){if(j&&this.color==j.color){j.rediscoverGroup()}})}};function g(k){if(!k){k=[]}this.stones=k;var j;for(j=0;j<k.length;j++){k[j].group=this}}g.prototype.setNewGroup=function(k){var j;if(this!=k){for(j=0;j<this.stones.length;j++){this.stones[j].group=k}k.stones=k.stones.concat(this.stones)}};g.prototype.hasLiberty=function(){return this.stones.some(function(j){return j.hasLiberty()})};g.prototype.die=function(){this.stones.forEach(function(j){j.group=null;j.removeFromBoard()})};function h(){this.board=new c();this.current_move=null;this.root_move=null;this._static_moves={w:{},b:{}};this._variation_stack=[];this._variation_index=-1}h.prototype.loadFromSgfString=function(r){var p=/\[[^\]]*\]/,l,o,m,k,n,u,s=[],q,t,j;this.board.clearBoard();while(r.length>0){q=r.search(p);if(q>=0){t=p.exec(r);j=r.substr(0,q).replace(/\s/g,"");r=r.substr(q+t[0].length);k="";while(j.length>0){n=j.charAt(0);j=j.substr(1);if(n==="("){if(o){s.push(l)}}else{if(n===")"){if(s.length>0){l=s.pop()}}else{if(n===";"){o=l;l=new f();m=m?m:l;if(o){o.addNextMove(l)}}else{k+=n}}}}k=k.trim();if(k){u=k}else{k=u}if(l){if(l.meta.indexOf(k)<0){l.meta+=" "+k;l.meta=l.meta.trim()}value=t[0].replace(/[\]\[]/g,"");if(k=="B"||k=="W"){l.color=k;l.position=value}else{if(k=="C"){l.comment=value}else{if(k=="AW"){l.aw.push(value)}else{if(k=="AB"){l.ab.push(value)}else{if(k=="AE"){l.ae.push(value)}else{if(k=="LB"){l.lb.push(value)}else{if(k=="TR"){l.tr.push(value)}}}}}}}}}else{j=r;r=""}}this._setCurrentMove(m);this.root_move=m;this._applyStatic();this.board.dispatchEvent("change")};h.prototype._applyStatic=function(){var l=this.current_move,m,o,n,k=this._static_moves.w,j=this._static_moves.b;for(coded_coord in k){o=a(coded_coord);n=this.board.stones[o[0]][o[1]];if(n){n.removeFromBoard()}}for(coded_coord in j){o=a(coded_coord);n=this.board.stones[o[0]][o[1]];if(n){n.removeFromBoard()}}for(m=0;m<l.aw.length;m++){coded_coord=l.aw[m];delete j[coded_coord];k[coded_coord]=true}for(m=0;m<l.ab.length;m++){coded_coord=l.ab[m];delete k[coded_coord];j[coded_coord]=true}for(m=0;m<l.ae.length;m++){coded_coord=l.ae[m];delete j[coded_coord];delete k[coded_coord]}for(coded_coord in k){o=a(coded_coord);this.board.addStone(o[0],o[1],"w",true)}for(coded_coord in j){o=a(coded_coord);this.board.addStone(o[0],o[1],"b",true)}this.current_move.raw_static=JSON.stringify(this._static_moves)};h.prototype.setVariationStack=function(j){this._variation_stack=j};h.prototype.nextMove=function(){return this._nextMove(false)};h.prototype._nextMove=function(j){var k,l;if(this.current_move.next_move){if(!this.current_move.raw_board){this.current_move.raw_board=this.board.serialize()}if(!this.current_move.raw_static){this.current_move.raw_static=JSON.stringify(this._static_moves)}if(Object.prototype.toString.call(this.current_move.next_move)==="[object Array]"){this._variation_index++;if(!(this._variation_index in this._variation_stack)){this._variation_stack[this._variation_index]=0}k=this._variation_stack[this._variation_index];this._setCurrentMove(this.current_move.next_move[k])}else{this._setCurrentMove(this.current_move.next_move)}if(this.current_move.raw_board){this.board.deserialize(this.current_move.raw_board);this._static_moves=JSON.parse(this.current_move.raw_static)}else{l=a(this.current_move.position);if(l&&this.current_move.color){this.board.addStone(l[0],l[1],this.current_move.color.toLowerCase(),j)}this._applyStatic();if(!j){this.board.dispatchEvent("change")}this.current_move.raw_board=this.board.serialize()}}};h.prototype.previousMove=function(){if(this.current_move.previous_move){this._setCurrentMove(this.current_move.previous_move);if(Object.prototype.toString.call(this.current_move.next_move)==="[object Array]"){this._variation_index--}this.board.deserialize(this.current_move.raw_board);this._static_moves=JSON.parse(this.current_move.raw_static)}};h.prototype.playMove=function(){};h.prototype.jumpToMove=function(j){var k=0;this._setCurrentMove(this.root_move);this._variation_index=-1;this.board.clearBoard();while(k<j){this._nextMove(true);k++}this.board.dispatchEvent("change")};h.prototype._setCurrentMove=function(j){this.current_move=j;this.board.clearAnnotations();var l,m,k;for(l=0;l<j.lb.length;l++){k=j.lb[l].split(":");m=a(k[0]);this.board.annotations[m[0]][m[1]]=k[1]}for(l=0;l<j.tr.length;l++){m=a(j.tr[l]);this.board.annotations[m[0]][m[1]]="[tr]"}};function f(){this.color=null;this.raw_board=null;this.raw_static=null;this.comment="";this.position=null;this.next_move=null;this.previous_move=null;this.meta="";this.aw=[];this.ab=[];this.ae=[];this.lb=[];this.tr=[]}f.prototype.addNextMove=function(j){if(this.next_move==null){this.next_move=j}else{if(this.next_move instanceof f){this.next_move=[this.next_move,j]}else{this.next_move.push(j)}}j.previous_move=this};function a(j){if(j){return[j.charCodeAt(0)-97,j.charCodeAt(1)-97]}else{return[]}}function e(t,k){var w=k.getContext("2d"),q=450,u=10,p,n,y,v,s,o,l,m,r,x;w.clearRect(0,0,500,500);w.beginPath();for(p=0;p<=18;p++){y=p/18*q+u;w.moveTo(y,u);w.lineTo(y,q+u)}for(p=0;p<=18;p++){v=p/18*q+u;w.moveTo(u,v);w.lineTo(q+u,v)}w.fillStyle="rgb(0,0,0)";for(p=3;p<=15;p++){for(n=3;n<=15;n++){if(p%6==3&&n%6==3){y=p/18*q+u;v=n/18*q+u;w.fillRect(y-3,v-3,6,6)}}}w.strokeStyle="rgb(0,0,0)";w.lineWidth=1;w.stroke();w.closePath();for(p=0;p<t.stones.length;p++){for(n=0;n<t.stones[p].length;n++){l=t.stones[p][n];annotation=t.annotations[p][n];s=p/18*q+u;o=n/18*q+u;r=q/(18*3);if(l){w.beginPath();w.arc(s,o,r,0,2*Math.PI);w.strokeStyle="rgb(0,0,0)";w.stroke();if(l.color=="b"){w.fillStyle="rgb(0,0,0)"}else{w.fillStyle="rgb(255,255,255)"}w.fill();w.closePath()}m=l&&l.color=="b";if(annotation){if(annotation=="[tr]"){x=r+2;w.beginPath();w.moveTo(s,o-x);w.lineTo(s+x*Math.sqrt(3)/2,o+x/2);w.lineTo(s-x*Math.sqrt(3)/2,o+x/2);w.lineTo(s,o-x);if(m){w.strokeStyle="rgb(255,255,255)"}else{w.strokeStyle="rgb(0,0,0)"}w.stroke();w.closePath()}else{if(!m){w.beginPath();w.arc(s,o,r,0,2*Math.PI);w.strokeStyle="rgb(255,255,255)";w.stroke();w.fillStyle="rgb(255,255,255)";w.fill();w.closePath()}w.beginPath();w.font="normal 12px Verdana";w.fillStyle=m?"rgb(255,255,255)":"rgb(0,0,0)";text_metrics=w.measureText(annotation);w.fillText(annotation,s-text_metrics.width/2,o+4);w.closePath()}}}}}d.fn.kifu=function(l){if(this.length==0||!this[0].getContext){return this}var k=this.data("kifu_record"),j=this;if(!k){k=new h();k.board.addEventListener("change",function(){e(this,j[0])});if(typeof l==="string"){if(b(l,".sgf")){return d.ajax({url:l,dataType:"text",success:function(m){k.loadFromSgfString(m);j.data("kifu_record",k)}})}else{k.loadFromSgfString(l)}}else{k.loadFromSgfString(this.html())}e(k.board,this[0]);this.data("kifu_record",k)}return k};function b(k,j){return k.indexOf(j,k.length-j.length)!==-1}})(jQuery);