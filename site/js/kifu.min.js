(function(f){function d(k){this.size=parseInt(k)||19;this.stones=null;this.annotations=null;this._events={};this.clearBoard();this.clearAnnotations()}d.prototype.addEventListener=function(l,m){var k=this._events[l]=this._events[l]||[];k.push(m)};d.prototype.dispatchEvent=function(n,k){if(this._events.hasOwnProperty(n)){var m=this._events[n],l;for(l=0;l<m.length;l++){m[l].apply(this,k)}}};d.prototype.clearAnnotations=function(){this.annotations=new Array(this.size);for(var k=0;k<this.stones.length;k++){this.annotations[k]=new Array(this.size)}};d.prototype.clearBoard=function(){this.stones=new Array(this.size);for(var k=0;k<this.stones.length;k++){this.stones[k]=new Array(this.size)}};d.prototype.addStone=function(k,o,m,l){if(k<this.stones.length&&o<this.stones.length&&!this.stones[k][o]){var n=new j(k,o,this,m);this.stones[k][o]=n;n.mergeGroup();n.killNeighbors()}if(!l){this.dispatchEvent("change")}};d.prototype.serialize=function(){var k={w:[],b:[],size:this.size},n,m,l;for(m=0;m<this.stones.length;m++){for(l=0;l<this.stones.length;l++){n=this.stones[m][l];if(n){k[n.color].push({x:m,y:l})}}}return JSON.stringify(k)};d.prototype.deserialize=function(k){if(typeof k==="string"){k=JSON.parse(k)}var l=this;l.size=k.hasOwnProperty("size")?k.size:19;l.clearBoard();if(k.hasOwnProperty("w")){k.w.forEach(function(m){l.addStone(m.x,m.y,"w",true)})}if(k.hasOwnProperty("b")){k.b.forEach(function(m){l.addStone(m.x,m.y,"b",true)})}this.dispatchEvent("change")};function j(k,n,m,l){this.x=k;this.y=n;this.board=m;this.color=l;this.group=null}j.prototype.neighbors=function(o,n){n=n||"map";var m=[{x:this.x-1,y:this.y},{x:this.x+1,y:this.y},{x:this.x,y:this.y-1},{x:this.x,y:this.y+1}],l=this.board,k=this;return m.filter(function(p){return p.x>=0&&p.y>=0&&p.x<l.stones.length&&p.y<l.stones.length})[n](function(p){return o.call(k,l.stones[p.x][p.y])})};j.prototype.rediscoverGroup=function(l){if(!l){l=new h()}if(this.group){this.group.stones=this.group.stones.filter(function(m){return m!=this})}this.group=l;this.group.stones.push(this);var k=function(m){if(m&&this.color==m.color&&this.group!=m.group){m.rediscoverGroup(l)}};this.neighbors(k)};j.prototype.mergeGroup=function(){var k=function(l){if(l&&l.color==this.color){var m=l.group;if(this.group&&m){m.setNewGroup(this.group)}else{if(m){this.group=m;m.stones.push(this)}else{if(this.group){l.group=this.group;this.group.stones.push(l)}else{l.group=this.group=new h([this,l])}}}}};this.neighbors(k)};j.prototype.killNeighbors=function(){var k=function(m){if(m&&m.color!=this.color){var l=m.group||m;if(!l.hasLiberty()){this.board.dispatchEvent("stones_killed",l.die())}}};this.neighbors(k)};j.prototype.hasLiberty=function(){var k=function(l){return !l};return this.neighbors(k,"some")};j.prototype.die=function(){this.removeFromBoard()};j.prototype.removeFromBoard=function(){this.board.stones[this.x][this.y]=null;if(this.group){this.group=null;this.neighbors(function(k){if(k&&this.color==k.color){k.rediscoverGroup()}})}};function h(l){if(!l){l=[]}this.stones=l;var k;for(k=0;k<l.length;k++){l[k].group=this}}h.prototype.setNewGroup=function(l){var k;if(this!=l){for(k=0;k<this.stones.length;k++){this.stones[k].group=l}l.stones=l.stones.concat(this.stones)}};h.prototype.hasLiberty=function(){return this.stones.some(function(k){return k.hasLiberty()})};h.prototype.die=function(){this.stones.forEach(function(k){k.group=null;k.removeFromBoard()});return[this.stones]};function i(){this.board=new d();this.current_move=null;this.root_move=null;this.black_player="";this.white_player="";this._static_moves={w:{},b:{}};this._variation_stack=[];this._variation_index=-1;var k=this;this.board.addEventListener("stones_killed",function(n){var p,o,m=k._static_moves.w,l=k._static_moves.b;if(n&&n.length){for(p=0;p<n.length;p++){for(o in m){if(o==a(n[p])){delete m[o]}}for(o in l){if(o==a(n[p])){delete l[o]}}}}})}i.prototype.loadFromSgfString=function(s){var q=/\[[^\]]*\]/,m,p,n,l,o,v,t=[],r,u,k;this.board.clearBoard();while(s.length>0){r=s.search(q);if(r>=0){u=q.exec(s);k=s.substr(0,r).replace(/\s/g,"");s=s.substr(r+u[0].length);l="";while(k.length>0){o=k.charAt(0);k=k.substr(1);if(o==="("){if(p){t.push(m)}}else{if(o===")"){if(t.length>0){m=t.pop()}}else{if(o===";"){p=m;m=new g();n=n?n:m;if(p){p.addNextMove(m)}}else{l+=o}}}}l=l.trim();if(l){v=l}else{l=v}if(m){if(m.meta.indexOf(l)<0){m.meta+=" "+l;m.meta=m.meta.trim()}value=u[0].replace(/[\]\[]/g,"");if(l=="B"||l=="W"){m.color=l;m.position=value}else{if(l=="C"){m.comment=value}else{if(l=="AW"){m.aw.push(value)}else{if(l=="AB"){m.ab.push(value)}else{if(l=="AE"){m.ae.push(value)}else{if(l=="LB"){m.lb.push(value)}else{if(l=="TR"){m.tr.push(value)}else{if(l=="CR"){m.cr.push(value)}else{if(l=="SZ"){this.board.size=parseInt(value);this.board.clearBoard()}else{if(l=="PW"){this.white_player=value}else{if(l=="PB"){this.black_player=value}}}}}}}}}}}}}else{k=s;s=""}}this._setCurrentMove(n);this.root_move=n;this._applyStatic();this.board.dispatchEvent("change")};i.prototype._applyStatic=function(){var m=this.current_move,n,p,o,l=this._static_moves.w,k=this._static_moves.b;for(coded_coord in l){p=b(coded_coord);o=this.board.stones[p[0]][p[1]];if(o){o.removeFromBoard()}}for(coded_coord in k){p=b(coded_coord);o=this.board.stones[p[0]][p[1]];if(o){o.removeFromBoard()}}for(n=0;n<m.aw.length;n++){coded_coord=m.aw[n];delete k[coded_coord];l[coded_coord]=true}for(n=0;n<m.ab.length;n++){coded_coord=m.ab[n];delete l[coded_coord];k[coded_coord]=true}for(n=0;n<m.ae.length;n++){coded_coord=m.ae[n];delete k[coded_coord];delete l[coded_coord]}for(coded_coord in l){p=b(coded_coord);this.board.addStone(p[0],p[1],"w",true)}for(coded_coord in k){p=b(coded_coord);this.board.addStone(p[0],p[1],"b",true)}this.current_move.raw_static=JSON.stringify(this._static_moves)};i.prototype.setVariationStack=function(k){this._variation_stack=k};i.prototype.nextMove=function(){return this._nextMove(false)};i.prototype._nextMove=function(k){var l,m;if(this.current_move.next_move){if(!this.current_move.raw_board){this.current_move.raw_board=this.board.serialize()}if(!this.current_move.raw_static){this.current_move.raw_static=JSON.stringify(this._static_moves)}if(Object.prototype.toString.call(this.current_move.next_move)==="[object Array]"){this._variation_index++;if(!(this._variation_index in this._variation_stack)){this._variation_stack[this._variation_index]=0}l=this._variation_stack[this._variation_index];this._setCurrentMove(this.current_move.next_move[l])}else{this._setCurrentMove(this.current_move.next_move)}if(this.current_move.raw_board){this.board.deserialize(this.current_move.raw_board);this._static_moves=JSON.parse(this.current_move.raw_static)}else{m=b(this.current_move.position);if(m&&this.current_move.color){this.board.addStone(m[0],m[1],this.current_move.color.toLowerCase(),k)}this._applyStatic();if(!k){this.board.dispatchEvent("change")}this.current_move.raw_board=this.board.serialize()}}};i.prototype.previousMove=function(){if(this.current_move.previous_move){this._setCurrentMove(this.current_move.previous_move);if(Object.prototype.toString.call(this.current_move.next_move)==="[object Array]"){this._variation_index--}this.board.deserialize(this.current_move.raw_board);this._static_moves=JSON.parse(this.current_move.raw_static)}};i.prototype.playMove=function(){};i.prototype.jumpToMove=function(k){var l=0;this._setCurrentMove(this.root_move);this._variation_index=-1;this.board.clearBoard();while(l<k){this._nextMove(true);l++}this.board.dispatchEvent("change")};i.prototype._setCurrentMove=function(k){this.current_move=k;this.board.clearAnnotations();var m,n,l;for(m=0;m<k.lb.length;m++){l=k.lb[m].split(":");n=b(l[0]);this.board.annotations[n[0]][n[1]]=l[1]}for(m=0;m<k.tr.length;m++){n=b(k.tr[m]);this.board.annotations[n[0]][n[1]]="[tr]"}for(m=0;m<k.cr.length;m++){n=b(k.cr[m]);this.board.annotations[n[0]][n[1]]="[cr]"}};function g(){this.color=null;this.raw_board=null;this.raw_static=null;this.comment="";this.position=null;this.next_move=null;this.previous_move=null;this.meta="";this.aw=[];this.ab=[];this.ae=[];this.lb=[];this.tr=[];this.cr=[]}g.prototype.addNextMove=function(k){if(this.next_move==null){this.next_move=k}else{if(this.next_move instanceof g){this.next_move=[this.next_move,k]}else{this.next_move.push(k)}}k.previous_move=this};function b(k){if(k){return[k.charCodeAt(0)-97,k.charCodeAt(1)-97]}else{return[]}}function a(k){if(k){return String.fromCharCode(k.x+97)+String.fromCharCode(k.y+97)}else{return""}}function e(t,k){var w=k.getContext("2d"),q=450,u=30,p,n,y,v,s,o,l,m,r,x;w.clearRect(0,0,500,500);w.beginPath();for(p=0;p<=t.size-1;p++){y=p/(t.size-1)*q+u;w.moveTo(y,u);w.lineTo(y,q+u)}for(p=0;p<=(t.size-1);p++){v=p/(t.size-1)*q+u;w.moveTo(u,v);w.lineTo(q+u,v)}if(t.size==19){w.fillStyle="rgb(0,0,0)";for(p=3;p<=15;p++){for(n=3;n<=15;n++){if(p%6==3&&n%6==3){y=p/(t.size-1)*q+u;v=n/(t.size-1)*q+u;w.fillRect(y-3,v-3,6,6)}}}}w.strokeStyle="rgb(0,0,0)";w.lineWidth=1;w.stroke();w.closePath();for(p=0;p<t.stones.length;p++){for(n=0;n<t.stones[p].length;n++){l=t.stones[p][n];annotation=t.annotations[p][n];s=p/(t.size-1)*q+u;o=n/(t.size-1)*q+u;r=q/((t.size-1)*3);if(l){w.beginPath();w.arc(s,o,r,0,2*Math.PI);w.strokeStyle="rgb(0,0,0)";w.stroke();if(l.color=="b"){w.fillStyle="rgb(0,0,0)"}else{w.fillStyle="rgb(255,255,255)"}w.fill();w.closePath()}m=l&&l.color=="b";if(annotation){x=r-1;if(annotation=="[tr]"){w.beginPath();w.moveTo(s,o-x);w.lineTo(s+x*Math.sqrt(3)/2,o+x/2);w.lineTo(s-x*Math.sqrt(3)/2,o+x/2);w.lineTo(s,o-x);if(m){w.strokeStyle="rgb(255,255,255)"}else{w.strokeStyle="rgb(0,0,0)"}w.stroke();w.closePath()}else{if(annotation=="[cr]"){w.beginPath();w.arc(s,o,r/2,0,2*Math.PI);if(m){w.strokeStyle="rgb(255,255,255)"}else{w.strokeStyle="rgb(0,0,0)"}w.stroke();w.closePath()}else{if(!m){w.beginPath();w.arc(s,o,r-1,0,2*Math.PI);w.strokeStyle="rgb(255,255,255)";w.stroke();w.fillStyle="rgb(255,255,255)";w.fill();w.closePath()}w.beginPath();w.font="normal 12px Verdana";w.fillStyle=m?"rgb(255,255,255)":"rgb(0,0,0)";text_metrics=w.measureText(annotation);w.fillText(annotation,s-text_metrics.width/2,o+4);w.closePath()}}}}}}f.fn.kifu=function(m){if(this.length==0||!this[0].getContext){return this}var l=this.data("kifu_record"),k=this;if(!l){l=new i();l.board.addEventListener("change",function(){e(this,k[0])});if(typeof m==="string"){if(c(m,".sgf")){return f.ajax({url:m,dataType:"text",success:function(n){l.loadFromSgfString(n);k.data("kifu_record",l)}})}else{l.loadFromSgfString(m)}}else{l.loadFromSgfString(this.html())}e(l.board,this[0]);this.data("kifu_record",l)}return l};function c(l,k){return l.indexOf(k,l.length-k.length)!==-1}})(jQuery);